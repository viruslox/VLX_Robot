# VLX_Robot - OBS Alert Overlay System

VLX_Robot is a self-hosted Go backend server for managing OBS alerts and overlays, with integration for Twitch events (via EventSub) and YouTube events (via API Polling).
NOTE: The idea, the logics, the architecture, reviews, validation are made in VirusLox, but the code is 95% generated by Gemini 2.5
Please check TODO file to keep track of what we still missing...todo

## Project Structure

```bash
VLX_Robot/
├── go.mod                # Go module definition file
├── go.sum                # Dependency checksums
├── main.go               # Application entry point. Starts the server.
├── config.yml            # Configuration (DB string, Twitch/YT API keys)
|
├── internal/             # Private Go project code
│   ├── config/           # Logic for loading config.yml
│   │   └── config.go
│   ├── database/         # Logic for PostgreSQL connection
│   │   └── postgres.go   # (Saves state and tokens)
│   ├── server/           # HTTP server logic
│   │   └── server.go     # (Sets up routes: /ws, /static/*, /webhooks)
│   ├── websocket/        # WebSocket Hub logic
│   │   ├── hub.go        # (Manages connections/broadcasts to overlays)
│   │   └── client.go
│   ├── twitch/           # Logic for Twitch EventSub
│   │   └── eventsub.go
│   └── youtube/          # Logic for YouTube API
│       └── youtube.go
│
└── static/               # <-- THIS IS YOUR FRONTEND FOLDER
    ├── overlay.html      # The HTML file you load into OBS
    ├── overlay.css       # The styles for your alerts
    └── overlay.js        # JS logic (WebSocket connection, show/hide alerts)
```

## 1. Installation

To install the necessary Go dependencies, run the following commands:

```bash
go get gopkg.in/yaml.v3
go get [github.com/lib/pq](https://github.com/lib/pq)
go get [github.com/nicklaw5/helix/v2](https://github.com/nicklaw5/helix/v2)
go get google.golang.org/api/option
go get google.golang.org/api/youtube/v3
go get [github.com/gorilla/websocket](https://github.com/gorilla/websocket)
```

Or, old but yet very good style:
- Install dependencies

```bash
cp -R <path_to_VLX_Robot>/VLX_Robot ~/go/src/
cd ~/go/src/VLX_Robot
go mod init
go mod tidy
go build
```

## 2. Configuration

Before starting the server, you must configure the config.yml file.

### A. Base Credentials

Fill in the following fields in `config.yml`:

* **`server.port`**: The port the server will run on (e.g., `8888`).
* **`server.base_url`**: The public HTTPS URL of your server. **Required** for Twitch webhooks. For local development, use a tunnel like `ngrok`.
* **`database`**: Enter your PostgreSQL connection details.
* **`twitch.client_id`** and **`twitch.client_secret`**: Get these by registering an app on the [Twitch Developer Console](https://dev.twitch.tv/console/apps).
* **`twitch.webhook_secret`**: A long, random secret string created by you (used to verify Twitch requests).
* **`youtube.api_key`**: Get this from the [Google Cloud Console](https://console.cloud.google.com/) by enabling the "YouTube Data API v3".
* **`monitoring`**: Enter the channel login names to monitor.

### B. Twitch User Token (CRITICAL)

To receive private events like **subscriptions, bit donations, and resubs**, an App Token is not enough. You need a **User Access Token** with the correct scopes (permissions).

1.  Open your browser and go to: `https://twitchtokengenerator.com`
2.  Click the **"Get Token with Custom Scopes"** button.
3.  On the next page, enter your **`Client ID`** (the same one you put in `config.yml`).
4.  Below, in the "Scopes" list, check (at a minimum) these two:
    * `channel:read:subscriptions`
    * `bits:read`
5.  Click **"Generate Token"**.
6.  You will be redirected to Twitch. Click **"Authorize"**.
7.  Copy the long string (the `access_token`) and paste it into the `user_access_token` field in your `config.yml`.


### C. Populate Alert Media

This script expects media files (GIFs, sounds) to exist. Make sure you:

1.  Create the `static/images/` and `static/sounds/` folders.
2.  Place your files inside (e.g., `follow.gif`, `sub.mp3`, `cheer.gif`, etc.).
3.  Verify that the file names match those "hard-coded" in the `static/overlay.js` file.

## 3. Startup

1.  **Start ngrok (for local dev):** If testing locally, start a tunnel to your chosen port:
    ```bash
    ngrok http 8888
    ```
2.  **Update `config.yml`**: Copy the `https://...` URL provided by ngrok into the `base_url` field of your `config.yml`.
3.  **Start the Go server**:
    ```bash
    go run main.go
    ```
4.  **Check the logs.** You should see the server start, connect to the DB, and register for Twitch events.


## 4. Usage in OBS

1.  Open OBS.
2.  Add a new "Browser" source (Sorgente Browser).
3.  In the "URL" box, enter the URL of your local overlay:
    ```bash
    http://localhost:8888/static/overlay.html
    ```
4.  Set the width and height (e.g., `1920` x `1080`).
5.  Ensure "Control audio via OBS" is **checked** if you want to manage alert audio.
6.  Click OK.


## 5. Troubleshooting and Important Notes

### Audio Autoplay (Common Problem)

Browsers (including the one in OBS) have a strict autoplay policy for audio. The `audio.play()` line might fail silently.

* **Solution 1 (Simple):** Right-click on your "Browser" source in OBS and choose **"Interact"**. Click once anywhere in the blank window. This "activates" the page, and sounds should work from then on.
* **Solution 2 (Advanced):** If you use OBS 25 or newer, you can add a special flag to the OBS Launch Options to disable this restriction:
    ```bash
    --autoplay-policy=no-user-gesture-required
    ```

### CSS Dependency

The `overlay.js` code is tightly coupled to your `overlay.css` file. Specifically, this line in `showAlert()`:
`setTimeout(..., 500); // Must match the 'transition' in CSS`

This `500` (milliseconds) **must** be identical to the transition time defined in your CSS (e.g., `transition: opacity 0.5s ease-out`). If you change the animation in CSS to `0.3s`, you must change this value to `300`, or the alerts will behave strangely.

### Missing Files

This script assumes all files (e.g., `/static/images/follow.gif`, `/static/sounds/alert.mp3`) exist. If a file is missing, the alert will still show but with a broken image or no sound (the `.catch()` on the audio prevents a crash). Ensure all paths and filenames are perfect.

## Come personalizzare un evento (Esempio: "Raid")

### Prepara i tuoi file:
* Crea la tua immagine (es. mio_raid.gif) e mettila in static/images/.
* Crea il tuo suono (es. allarme_raid.mp3) e mettilo in static/sounds/.

### Modifica static/overlay.js:
* Apri il file static/overlay.js.
* Trova la funzione processQueue().
    All'interno, cerca il switch (data.type) e trova il blocco case 'twitch_raid':.
    Il codice originale è questo:
```JavaScript
case 'twitch_raid':
    config.title = "Incoming Raid!"; [cite: 267]
    config.detail = `${data.raider_name} is raiding with ${data.viewers} viewers!`; [cite: 268]
    config.image = '/static/images/raid.gif'; [cite: 268]
    config.sound = '/static/sounds/raid.mp3'; [cite: 268]
    config.duration = 10000; [cite: 268]
    break;
```
    Modificalo per usare i tuoi file e il tuo testo:
```JavaScript

case 'twitch_raid':
    config.title = "ATTENZIONE: INVASIONE!"; // <-- Testo personalizzato
    config.detail = `Ci raida ${data.raider_name}!`; // <-- Testo dettaglio personalizzato
    config.image = '/static/images/mio_raid.gif'; // <-- TUA IMMAGINE
    config.sound = '/static/sounds/allarme_raid.mp3'; // <-- TUO SUONO
    config.duration = 7000; // <-- Durata personalizzata (in millisecondi)
    break;
```

Puoi ripetere questo processo per ogni singolo case dentro il blocco switch, personalizzando il testo (config.title, config.detail), l'immagine (config.image), il suono (config.sound) e la durata (config.duration) per ogni tipo di alert .


### Twitch follow
curl -X POST -d '{"type":"twitch_follow", "user_name":"UtenteDiTest"}' http://localhost:8001/test/alert

### YouTube superchat
curl -X POST -d '{"type":"youtube_super_chat", "user_name":"DonatoreTest", "amount_string":"€5.00", "message":"Test alert!"}' http://localhost:8001/test/alert

### Twitch raid
curl -X POST -d '{"type":"twitch_raid", "raider_name":"StreamerAmico", "viewers":120}' http://localhost:8001/test/alert

### Twitch subscriptions
curl -X POST -d '{"type":"twitch_subscribe", "user_name":"NuovoSub", "tier":"Tier 1", "months":1}' http://localhost:8001/test/alert
curl -X POST -d '{"type":"twitch_resubscribe", "user_name":"VecchioAmico", "tier":"Tier 2", "months":6, "message":"Sempre un grande!"}' http://localhost:8001/test/alert
curl -X POST -d '{"type":"twitch_gift_sub", "user_name":"Benefattore", "recipient_name":"Fortunato", "tier":"Tier 1"}' http://localhost:8001/test/alert

### Twitch cheers
curl -X POST -d '{"type":"twitch_cheer", "user_name":"Tifoso", "bits":500, "message":"Per la nuova sedia!"}' http://localhost:8001/test/alert

curl -X POST -d '{"type":"youtube_member", "user_name":"MembroYT", "level":"Livello Fan"}' http://localhost:8001/test/alert

curl -X POST -d '{"type":"stream_tip", "user_name":"DonatoreSegreto", "amount_string":"€20.00", "currency":"EUR", "message":"Grande live!"}' http://localhost:8001/test/alert

# TODO & Roadmap
Check the TODO.md file for the detailed development roadmap.
[x] Basic Twitch EventSub
[x] Twitch Chat Audio Commands
[x] WebSocket Overlay System
[ ] YouTube Live Chat Polling (In Progress)
[ ] YouTube Member Alerts
